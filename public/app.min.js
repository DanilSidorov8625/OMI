let canvas=document.getElementById("board"),ctx=canvas.getContext("2d"),uploadBtn=document.getElementById("uploadBtn"),fileInput=document.getElementById("fileInput"),captionInput=document.getElementById("caption"),statusEl=document.getElementById("status"),feedList=document.getElementById("feedList"),toggleFeedBtn=document.getElementById("toggleFeedBtn"),minimap=document.getElementById("minimap"),mmCtx=minimap.getContext("2d"),feedBackdrop=document.getElementById("feedBackdrop"),sidebar=document.getElementById("sidebar"),mobileHeaderToggle=document.getElementById("mobileHeaderToggle"),sidebarCloseBtn=document.getElementById("sidebarCloseBtn"),main=document.querySelector(".main"),mobileUploadBtn=document.getElementById("mobileUploadBtn"),mobileCaptionInput=document.getElementById("mobileCaption"),wrap=document.getElementById("canvasWrap"),LOG_ENDPOINT="/api/log",Log=(()=>{let i={levels:{debug:!0,log:!0,info:!0,warn:!0,error:!0},fetchIgnore:[/\/api\/grid\b/i,/\/api\/log\b/i],sample:{debug:.25,log:1,info:1,warn:1,error:1}};function t(e){try{localStorage.setItem("LOG_CONFIG",JSON.stringify(e))}catch{console.warn("Failed to save log config to localStorage")}}let o=(()=>{try{var e,t=localStorage.getItem("LOG_CONFIG");return t?(e=JSON.parse(t),{...i,...e,levels:{...i.levels,...e.levels||{}},sample:{...i.sample,...e.sample||{}},fetchIgnore:(Array.isArray(e.fetchIgnore)?e:i).fetchIgnore}):{...i}}catch{return{...i}}})(),n=(window.LogConfig={get:()=>({...o}),set:e=>{t(o={...o,...e})},levels:e=>{o.levels={...o.levels,...e},t(o)},ignore:e=>{o.fetchIgnore=e||[],t(o)},sample:e=>{o.sample={...o.sample,...e},t(o)},reset:()=>{t(o={...i})}},{log:console.log.bind(console),info:console.info.bind(console),warn:console.warn.bind(console),error:console.error.bind(console),debug:(console.debug||console.log).bind(console)}),a=[],e=null,r=20,l=1500,s=5e3;function c(e){try{return e instanceof Error?{__type:"Error",name:e.name,message:e.message,stack:e.stack}:e&&"object"==typeof e?JSON.parse(JSON.stringify(e,(e,t)=>"function"==typeof t?"[Function]":t)):String(e)}catch{try{return String(e)}catch{return"[Unserializable]"}}}function d(){return(new Date).toISOString()}async function m(){if(a.length){var e=a.splice(0,r),e={ts:d(),page:location.href,ua:navigator.userAgent,lang:navigator.language,screen:{w:window.screen?.width,h:window.screen?.height,dpr:window.devicePixelRatio||1},events:e};try{await fetch(LOG_ENDPOINT,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e),keepalive:!0})}catch{}finally{a.length&&g()}}}function g(){clearTimeout(e),e=setTimeout(m,l)}function h(e){(e=>o.levels[e]&&(e=o.sample[e]??1,Math.random()<e))(e.level)&&(Array.isArray(e.args)&&(e.args=e.args.map(e=>{e="string"==typeof e?e:JSON.stringify(c(e));return e.length>s?e.slice(0,s)+"â€¦[trunc]":e})),a.push(e),(a.length>=r?m:g)())}let u=window.fetch.bind(window);return window.fetch=async(...t)=>{var i=performance.now(),n=t[0]&&t[0].toString()||"",a=!(t=>{try{return o.fetchIgnore.some(e=>"string"==typeof e?t.includes(e):e instanceof RegExp&&e.test(t))}catch{}})(n);try{var e,r=await u(...t);return a&&(e=Math.round(performance.now()-i),h({level:"debug",ts:d(),args:["[fetch]",n,r.status,e+"ms"]})),r}catch(e){throw a&&(t=Math.round(performance.now()-i),h({level:"error",ts:d(),args:["[fetch error]",n,e?.message||String(e),t+"ms"]})),e}},window.addEventListener("beforeunload",()=>{m()}),{init:function(){["log","info","warn","error","debug"].forEach(t=>{console[t]=(...e)=>{n[t](...e),h({level:t,ts:d(),args:e})}}),window.addEventListener("error",e=>{h({level:"error",ts:d(),args:["[window.onerror]",e.message,e.filename+`:${e.lineno}:`+e.colno,e.error?e.error.stack||e.error.message:null]})}),window.addEventListener("unhandledrejection",e=>{h({level:"error",ts:d(),args:["[unhandledrejection]",c(e.reason)]})}),console.info("[client] logger initialized")},flush:m,push:h}})(),isMobileConnect=(Log.init(),/Mobi|Android/i.test(navigator.userAgent)),GRID={w:1e3,h:1e3,slotSize:40},scale=.25,origin={x:0,y:0},dpr=window.devicePixelRatio||1,LOD_SWITCH_PX=isMobileConnect?300:160,dragging=!1,dragStart={x:0,y:0},originStart={x:0,y:0},highlightTile=null,highlightTimer=null,pendingSlot=null,GRID_LINE_VISIBILITY_THRESHOLD=.1,Cache=(()=>{let c=new Map;function e(e,t){return e+","+t}function n(e){e=c.get(e);e&&(e.lastUsed=performance.now())}return{map:c,ensureThumb:function({key:e,thumbUrl:t}){let i=c.get(e);i?(i.thumbUrl!==t&&(i.thumbUrl=t,i.thumbReady=!1,i.thumbImg=new Image,i.thumbImg.decoding="async",isMobileConnect||(i.thumbImg.loading="lazy"),i.thumbImg.onload=()=>{i.thumbReady=!0,n(e),requestDraw()},i.thumbImg.src=t),n(e)):((i={thumbUrl:t,fullUrl:null,thumbImg:new Image,fullImg:null,thumbReady:!1,fullReady:!1,loadingFull:!1,lastUsed:performance.now()}).thumbImg.decoding="async",isMobileConnect||(i.thumbImg.loading="lazy"),i.thumbImg.onload=()=>{i.thumbReady=!0,n(e),requestDraw()},i.thumbImg.src=t,c.set(e,i))},ensureFull:function({key:e,fullUrl:t}){let i=c.get(e);i&&t&&(i.fullUrl=t,i.fullReady||i.loadingFull||(i.loadingFull=!0,i.fullImg=new Image,i.fullImg.decoding="async",i.fullImg.onload=()=>{i.fullReady=!0,i.loadingFull=!1,n(e),requestDraw()},i.fullImg.src=t),n(e))},touch:n,evictIfNeeded:function(e){if(!(c.size<=5e3)){var[e,i,n,a]=e,r=new Set;for(let t=Math.max(0,e-2);t<=Math.min(GRID.w-1,n+2);t++)for(let e=Math.max(0,i-2);e<=Math.min(GRID.h-1,a+2);e++)r.add(t+","+e);var t,o,l,s=[];for([t,o]of c)r.has(t)||s.push([t,o.lastUsed||0]);s.sort((e,t)=>e[1]-t[1]);for([l]of s.slice(0,Math.max(0,c.size-5e3)))c.delete(l)}},keyOf:e}})();function getMinScale(){var e=canvas.width/dpr/(GRID.w*GRID.slotSize),t=canvas.height/dpr/(GRID.h*GRID.slotSize);return Math.max(e,t)}function escapeHtml(e){return String(e).replace(/[&<>"']/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[e])}function snapPx(e){return Math.round(e*dpr)/dpr}function clampOrigin(){var e=GRID.slotSize*scale,t=canvas.width/dpr/e,e=canvas.height/dpr/e;origin.x=Math.max(0,Math.min(GRID.w-t,origin.x)),origin.y=Math.max(0,Math.min(GRID.h-e,origin.y))}function computeTargetOrigin(e,t,i){var n=canvas.width/dpr/(GRID.slotSize*i),i=canvas.height/dpr/(GRID.slotSize*i),e=e+.5-n/2,t=t+.5-i/2;return{ox:Math.max(0,Math.min(GRID.w-n,e)),oy:Math.max(0,Math.min(GRID.h-i,t)),tilesWide:n,tilesHigh:i}}function animateToTile(e,t,n=300,a=1){let r=scale;var i=getMinScale(),i=(a=Math.max(a,i),computeTargetOrigin(e,t,r)),e=computeTargetOrigin(e,t,a);let o=i.ox,l=i.oy,s=e.ox,c=e.oy,d=performance.now();requestAnimationFrame(function e(t){var t=Math.min(1,(t-d)/n),i=(i=t)<.5?2*i*i:1-Math.pow(-2*i+2,2)/2;scale=r+(a-r)*i,origin.x=o+(s-o)*i,origin.y=l+(c-l)*i,requestDraw(),t<1&&requestAnimationFrame(e)})}function setHighlight(e,t,i=2e3){highlightTile={x:e,y:t},highlightTimer&&clearTimeout(highlightTimer),highlightTimer=setTimeout(()=>{highlightTile=null},i)}let sidebarOpen=!0;function isMobile(){return window.matchMedia("(max-width: 768px)").matches}function updateToggleText(){isMobile()?mobileHeaderToggle.innerHTML=sidebarOpen?"ðŸ‘ï¸":"ðŸ‘€":toggleFeedBtn.innerHTML=sidebarOpen?"ðŸ‘ï¸ Hide Sidebar":"ðŸ‘€ Show Sidebar"}function applySidebarState(){isMobile()?(main.classList.remove("sidebar-hidden"),sidebarOpen?(sidebar.classList.add("open"),feedBackdrop.classList.add("active"),document.body.style.overflow="hidden"):(sidebar.classList.remove("open"),feedBackdrop.classList.remove("active"),document.body.style.overflow="")):(sidebar.classList.remove("open"),feedBackdrop.classList.remove("active"),document.body.style.overflow="",sidebarOpen?main.classList.remove("sidebar-hidden"):main.classList.add("sidebar-hidden"))}function toggleSidebar(){sidebarOpen=!sidebarOpen,applySidebarState(),updateToggleText(),resize(),requestAnimationFrame(resize),setTimeout(resize,350)}function resizeMinimap(){var e=minimap.getBoundingClientRect(),t=window.devicePixelRatio||1;minimap.width=Math.max(100,Math.floor(e.width*t)),minimap.height=Math.max(100,Math.floor(e.height*t)),mmCtx.setTransform(t,0,0,t,0,0)}function resize(){var e=document.getElementById("canvasWrap"),t=document.getElementById("topbar"),t=Math.max(0,window.innerHeight-(t?.offsetHeight||80)),t=(e.style.height=t+"px",e.clientWidth),e=e.clientHeight;dpr=window.devicePixelRatio||1,canvas.width=Math.floor(t*dpr),canvas.height=Math.floor(e*dpr),canvas.style.width=t+"px",canvas.style.height=e+"px",ctx.setTransform(dpr,0,0,dpr,0,0),clampOrigin(),resizeMinimap(),applySidebarState(),requestDraw()}window.addEventListener("resize",resize),window.addEventListener("orientationchange",resize);let resizeTimeout,ro=(window.addEventListener("resize",()=>{clearTimeout(resizeTimeout),resizeTimeout=setTimeout(()=>{applySidebarState(),updateToggleText()},150)}),new ResizeObserver(()=>{resize()}));async function ensureFullOnDemand(e,t){var i=Cache.keyOf(e,t),n=Cache.map.get(i);if(n&&!n.fullReady&&!n.loadingFull)try{var a=await(await fetch(`/api/slots?x0=${e}&y0=`+t)).json(),r=Array.isArray(a.rows)?a.rows[0]:a.rows;r?.originalUrl&&Cache.ensureFull({key:i,fullUrl:r.originalUrl})}catch(n){console.warn("grid fetch: failed",n)}}function drawMinimap(){var e=minimap.width/dpr,t=minimap.height/dpr,i=(mmCtx.clearRect(0,0,e,t),mmCtx.fillStyle="#0b1220",mmCtx.fillRect(0,0,e,t),e/GRID.w),n=t/GRID.h,a=Math.min(i,n),r=(e-GRID.w*a)/2,o=(t-GRID.h*a)/2;mmCtx.strokeStyle="rgba(255,255,255,0.06)",mmCtx.lineWidth=1;for(let e=0;e<=GRID.w;e+=100){var l=r+e*a;mmCtx.beginPath(),mmCtx.moveTo(l,o),mmCtx.lineTo(l,o+GRID.h*a),mmCtx.stroke()}for(let e=0;e<=GRID.h;e+=100){var s=o+e*a;mmCtx.beginPath(),mmCtx.moveTo(r,s),mmCtx.lineTo(r+GRID.w*a,s),mmCtx.stroke()}mmCtx.fillStyle="rgba(255,255,255,0.75)";let c=0;var d,m,g,h,u=Math.max(1,Math.floor(a)),p=Math.max(1,Math.floor(a));for([d,m]of Cache.map){if(25e3<=c)break;(m.thumbReady||m.fullReady)&&([g,h]=d.split(",").map(Number),g<0||g>=GRID.w||h<0||h>=GRID.h||(g=Math.floor(r+g*a),h=Math.floor(o+h*a),mmCtx.fillRect(g,h,u,p),c++))}i=canvas.width/dpr/(GRID.slotSize*scale),n=canvas.height/dpr/(GRID.slotSize*scale),e=r+origin.x*a,t=o+origin.y*a,i*=a,n*=a;mmCtx.fillStyle="rgba(59,130,246,0.15)",mmCtx.fillRect(e,t,i,n),mmCtx.strokeStyle="rgba(59,130,246,0.9)",mmCtx.lineWidth=2,mmCtx.strokeRect(e,t,i,n)}function drawGrid(){ctx.clearRect(0,0,canvas.width/dpr,canvas.height/dpr);var i=GRID.slotSize*scale,e=Math.ceil(canvas.width/dpr/i)+2,t=Math.ceil(canvas.height/dpr/i)+2,n=Math.max(0,Math.floor(origin.x)),a=Math.max(0,Math.floor(origin.y)),r=Math.min(GRID.w-1,n+e),o=Math.min(GRID.h-1,a+t);if(scale>=GRID_LINE_VISIBILITY_THRESHOLD){ctx.strokeStyle="rgba(255,255,255,0.06)",ctx.lineWidth=1;for(let e=n;e<=r;e++){var l=snapPx((e-origin.x)*i);ctx.beginPath(),ctx.moveTo(l,0),ctx.lineTo(l,canvas.height/dpr),ctx.stroke()}for(let e=a;e<=o;e++){var s=snapPx((e-origin.y)*i);ctx.beginPath(),ctx.moveTo(0,s),ctx.lineTo(canvas.width/dpr,s),ctx.stroke()}}var e=i*dpr,t=Math.abs(Math.round(e)-e)<.001;ctx.imageSmoothingEnabled=!t,ctx.imageSmoothingQuality="low";for(let t=n;t<=r;t++)for(let e=a;e<=o;e++){var c,d,m=Cache.keyOf(t,e),g=Cache.map.get(m);g&&(i>=LOD_SWITCH_PX&&!g.fullReady&&(g.fullUrl?Cache.ensureFull({key:m,fullUrl:g.fullUrl}):ensureFullOnDemand(t,e)),c=snapPx((t-origin.x)*i),d=snapPx((e-origin.y)*i),g=i>=LOD_SWITCH_PX&&g.fullReady&&g.fullImg?g.fullImg:g.thumbReady&&g.thumbImg?g.thumbImg:null)&&(ctx.drawImage(g,c,d,i,i),Cache.touch(m))}highlightTile&&(e=(highlightTile.x-origin.x)*i,t=(highlightTile.y-origin.y)*i,ctx.save(),ctx.strokeStyle="yellow",ctx.lineWidth=3,ctx.strokeRect(e,t,i,i),ctx.restore())}ro.observe(wrap);let mmDragging=!1;function mmClientToTile(e){var t=minimap.getBoundingClientRect(),i=e.clientX-t.left,e=e.clientY-t.top,n=t.width,t=t.height,a=n/GRID.w,r=t/GRID.h,a=Math.min(a,r),r=(n-GRID.w*a)/2,n=(t-GRID.h*a)/2;return{gx:Math.max(0,Math.min(GRID.w,(i-r)/a)),gy:Math.max(0,Math.min(GRID.h,(e-n)/a))}}function mmRecenterTo(e){var{gx:e,gy:t}=mmClientToTile(e),i=canvas.width/dpr/(GRID.slotSize*scale),n=canvas.height/dpr/(GRID.slotSize*scale);origin.x=e-i/2,origin.y=t-n/2,clampOrigin(),requestDraw()}function requestDraw(){drawGrid(),scheduleFetch(),drawMinimap()}minimap.addEventListener("mousedown",e=>{mmDragging=!0,mmRecenterTo(e)}),window.addEventListener("mouseup",()=>{mmDragging=!1}),minimap.addEventListener("mousemove",e=>{mmDragging&&mmRecenterTo(e)}),minimap.addEventListener("click",mmRecenterTo);let fetchTimer=null,rateBackoffMs=0,BASE_DELAY_MS=120,MAX_BACKOFF_MS=5e3;function scheduleFetch(e=0){clearTimeout(fetchTimer);e=BASE_DELAY_MS+rateBackoffMs+e;fetchTimer=setTimeout(fetchViewport,e)}async function fetchViewport(){try{var t=Math.ceil(canvas.width/dpr/(GRID.slotSize*scale))+2,i=Math.ceil(canvas.height/dpr/(GRID.slotSize*scale))+2,n=Math.max(0,Math.floor(origin.x)),a=Math.max(0,Math.floor(origin.y)),r=Math.min(GRID.w-1,n+t),o=Math.min(GRID.h-1,a+i),l=Math.max(0,n-12),s=Math.max(0,a-12),c=Math.min(GRID.w-1,r+12),d=Math.min(GRID.h-1,o+12),m=await fetch(`/api/grid?x0=${l}&y0=${s}&x1=${c}&y1=`+d);if(!m.ok)return 429===m.status?(rateBackoffMs=Math.min(MAX_BACKOFF_MS,Math.max(250,2*rateBackoffMs||250)),console.warn("grid fetch rate-limited (429). Backing off",rateBackoffMs,"ms"),void scheduleFetch()):(console.warn("grid fetch failed:",m.status),void scheduleFetch(300));let e;try{e=await m.json()}catch(e){return console.warn("grid fetch: invalid JSON",e),void scheduleFetch(300)}var g=e&&Array.isArray(e.rows)?e.rows:[];0===g.length?(rateBackoffMs=0,requestDraw()):(g.forEach(e=>{var t=Cache.keyOf(e.x,e.y);Cache.ensureThumb({key:t,thumbUrl:e.thumbUrl})}),rateBackoffMs=0,Cache.evictIfNeeded([n,a,r,o]),requestDraw())}catch(e){console.error("fetchViewport error:",e),scheduleFetch(500)}}function prependFeed(e){var t=document.createElement("li");for(t.dataset.x=e.x,t.dataset.y=e.y,t.className="feed-item",t.setAttribute("role","button"),t.tabIndex=0,t.style.cursor="pointer",t.innerHTML=`
    <div class="placeholder-img">
      <img src="${e.thumbUrl}" alt="thumb" style="width: 100%; height: 100%; object-fit: cover; border-radius: 12px;"/>
    </div>
    <div class="feed-item-content">
      <div class="feed-item-coords">(${e.x}, ${e.y})</div>
      <div class="feed-item-caption">${escapeHtml(e.caption||"(no caption)")}</div>
    </div>
  `,feedList.prepend(t);50<feedList.children.length;)feedList.removeChild(feedList.lastChild)}toggleFeedBtn.addEventListener("click",toggleSidebar),mobileHeaderToggle.addEventListener("click",toggleSidebar),sidebarCloseBtn.addEventListener("click",toggleSidebar),feedBackdrop.addEventListener("click",()=>{isMobile()&&sidebarOpen&&toggleSidebar()}),feedList.addEventListener("click",e=>{var t,e=e.target.closest("li");e&&(t=Number(e.dataset.x),e=Number(e.dataset.y),Number.isFinite(t))&&Number.isFinite(e)&&(animateToTile(t,e,500,5),setHighlight(t,e,2e3),isMobile())&&sidebarOpen&&toggleSidebar()}),canvas.addEventListener("pointerdown",e=>{canvas.setPointerCapture(e.pointerId),canvas.style.cursor="grabbing",dragging=!0,dragStart={x:e.clientX,y:e.clientY},originStart={...origin}}),canvas.addEventListener("pointerup",e=>{canvas.releasePointerCapture(e.pointerId),dragging=!1,canvas.style.cursor="crosshair"}),canvas.addEventListener("pointermove",e=>{var t,i;dragging&&(t=e.clientX-dragStart.x,e=e.clientY-dragStart.y,i=GRID.slotSize*scale,origin.x=originStart.x-t/i,origin.y=originStart.y-e/i,clampOrigin(),requestDraw())}),canvas.addEventListener("touchmove",e=>e.preventDefault(),{passive:!1}),canvas.addEventListener("wheel",e=>{e.preventDefault();var t=e.deltaY<0?1.1:.9,i=getMinScale(),n=origin.x+e.offsetX/(GRID.slotSize*scale),a=origin.y+e.offsetY/(GRID.slotSize*scale),t=scale*t,t=Math.max(i,Math.min(50,t));origin.x=n-e.offsetX/(GRID.slotSize*t),origin.y=a-e.offsetY/(GRID.slotSize*t),clampOrigin(),scale=t,requestDraw()},{passive:!1}),canvas.style.touchAction="none";let pointers=new Map,isPinching=!1,pinchState=null;function canvasClientToLocal(e,t){var i=canvas.getBoundingClientRect();return{x:e-i.left,y:t-i.top}}function getCentroid(){var e=[...pointers.values()];return{x:(e[0].x+e[1].x)/2,y:(e[0].y+e[1].y)/2}}function getDistance(){var e=[...pointers.values()];return Math.hypot(e[0].x-e[1].x,e[0].y-e[1].y)}function beginPinch(){isPinching=!0,dragging=!1;var e=getDistance(),t=getCentroid(),{x:t,y:i}=canvasClientToLocal(t.x,t.y),t=screenToGrid(t,i);pinchState={startDist:e,startScale:scale,centerGrid:t}}function updatePinch(){var e,t,i,n;!isPinching||pointers.size<2||!pinchState||(n=getDistance(),{x:e,y:t}=canvasClientToLocal((e=getCentroid()).x,e.y),i=getMinScale(),n=pinchState.startScale*(n/pinchState.startDist),n=Math.max(i,Math.min(50,n)),origin.x=pinchState.centerGrid.x-e/(GRID.slotSize*n),origin.y=pinchState.centerGrid.y-t/(GRID.slotSize*n),scale=n,clampOrigin(),requestDraw())}function endPinch(){isPinching=!1,pinchState=null}function removePointer(e){"touch"===e.pointerType&&(pointers.delete(e.pointerId),pointers.size<2)&&isPinching&&endPinch()}function handleUploadClick(){pendingSlot=null,fileInput.value="",fileInput.click()}function screenToGrid(e,t){return{x:origin.x+e/(GRID.slotSize*scale),y:origin.y+t/(GRID.slotSize*scale)}}function snapToTile(e){var t=Math.floor(e.x),e=Math.floor(e.y);return{x:Math.max(0,Math.min(GRID.w-1,t)),y:Math.max(0,Math.min(GRID.h-1,e))}}async function loadFeed(){var e=await(await fetch("/api/feed?limit=50")).json();feedList.innerHTML="",e.rows.forEach(prependFeed)}async function fetchConfig(){var e=await fetch("/api/config");GRID=(await e.json()).grid,loadFeed()}canvas.addEventListener("pointerdown",e=>{"touch"===e.pointerType&&(pointers.set(e.pointerId,{x:e.clientX,y:e.clientY}),2===pointers.size)&&beginPinch()}),canvas.addEventListener("pointermove",e=>{"touch"===e.pointerType&&pointers.has(e.pointerId)&&(pointers.set(e.pointerId,{x:e.clientX,y:e.clientY}),isPinching)&&updatePinch()}),canvas.addEventListener("pointerup",removePointer),canvas.addEventListener("pointercancel",removePointer),window.addEventListener("blur",()=>{isPinching&&endPinch(),pointers.clear()}),uploadBtn.addEventListener("click",handleUploadClick),mobileUploadBtn.addEventListener("click",handleUploadClick),captionInput.addEventListener("input",e=>{mobileCaptionInput.value=e.target.value}),mobileCaptionInput.addEventListener("input",e=>{captionInput.value=e.target.value}),canvas.addEventListener("dblclick",async e=>{try{var t,i,{x:n,y:a}=snapToTile(screenToGrid(e.offsetX,e.offsetY));if(!(n<0||n>=GRID.w||a<0||a>=GRID.h))return(t=await fetch(`/api/slots?x0=${n}&y0=`+a)).ok?(i=await t.json(),void((Array.isArray(i.rows)?0<i.rows.length:!!i.rows)?alert(`Slot (${n}, ${a}) is already taken`):confirm(`Upload to slot (${n}, ${a})?`)&&(pendingSlot={x:n,y:a},fileInput.value="",fileInput.click()))):429===t.status?void alert("Youâ€™re doing that a bit fastâ€”please wait a moment and try again."):(console.warn("slots lookup failed:",t.status),void alert("Could not verify slot. Please try again."))}catch(e){console.error("dblclick handler error:",e),alert("Something went wrong. Please try again.")}}),fileInput.addEventListener("change",async()=>{if(fileInput.files.length){var e=fileInput.files[0],t=new FormData,e=(t.append("image",e),captionInput.value||mobileCaptionInput.value);e&&t.append("caption",e),pendingSlot&&(t.append("x",String(pendingSlot.x)),t.append("y",String(pendingSlot.y)));try{statusEl.textContent="Uploadingâ€¦";var i=await fetch("/api/upload",{method:"POST",body:t}),n=await i.json();if(!i.ok)throw new Error(n.error||"Upload failed");statusEl.textContent=`Uploaded to (${n.slot.x}, ${n.slot.y})`,animateToTile(n.slot.x,n.slot.y,500,5),setHighlight(n.slot.x,n.slot.y,2e3)}catch(e){statusEl.textContent="Error: "+e.message}finally{pendingSlot=null,captionInput.value="",mobileCaptionInput.value="",setTimeout(()=>statusEl.textContent="",2500)}}});let socket=io();socket.on("connect",()=>console.log("socket connected",socket.id)),socket.on("connect_error",e=>console.error("socket connect_error",e)),socket.on("new_image",e=>{var t;e?.thumbUrl&&(t=Cache.keyOf(e.x,e.y),Cache.ensureThumb({key:t,thumbUrl:e.thumbUrl}),Cache.ensureFull({key:t,fullUrl:e.originalUrl||e.thumbUrl}),prependFeed({x:e.x,y:e.y,caption:e.caption,createdAt:e.createdAt,thumbUrl:e.thumbUrl,originalUrl:e.originalUrl||e.thumbUrl}),requestDraw())}),canvas.style.cursor="crosshair",fetchConfig().then(()=>{resize(),applySidebarState(),updateToggleText(),requestDraw()});